import{r as p,A as pe,a as P,B as ce,c as T,o as y,b as t,w as a,as as me,E as _e,a9 as fe,u as ye,l as m,t as d,e as ve,a4 as ge,a5 as be,k as s,$ as Ce,j as we,h as ke,ad as xe,F as he,m as Ee,d as $,ae as Ve,f as Se,g as Ae,am as Be,an as Te,ap as L,y as r}from"./index-vTAAATWV.js";/* empty css                     *//* empty css                       *//* empty css                  *//* empty css               *//* empty css                   *//* empty css                 *//* empty css                *//* empty css                        */import"./index-BRBj6Fej.js";/* empty css                   *//* empty css                       */import{t as V,a as $e}from"./test-plan-DwlkQCp9.js";import{a as M}from"./test-case-CNa3Bo-F.js";import{_ as De}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ie={class:"execution-page"},Re={class:"page-title"},Ue={class:"page-header"},Fe={class:"header-actions"},Ne={key:0,style:{"margin-top":"16px"}},Pe={class:"toolbar"},Le={__name:"Execution",setup(Me){const z=pe(),O=ye(),v=p(parseInt(z.params.planId)),D=p(""),S=p([]),_=p([]),g=p(!1),b=p(!1),h=p(null),I=p([]),f=p([]),R=p([]),C=P({keyword:"",suite_id:null}),n=P({status:"passed",actual_result:"",notes:"",defect_ids:null});function j(){O.push("/test-plans")}function U(o){return{critical:"danger",high:"warning",medium:"primary",low:"info"}[o]||"info"}function G(o){return{not_executed:"info",passed:"success",failed:"danger",blocked:"warning",skipped:"info"}[o]||"info"}function H(o){return{not_executed:"未执行",passed:"通过",failed:"失败",blocked:"阻塞",skipped:"跳过"}[o]||o}async function w(){var o,e;try{const c=await V.getDetail(v.value);D.value=((o=c.data)==null?void 0:o.name)||"",S.value=((e=c.data)==null?void 0:e.test_cases)||[]}catch(c){console.error("加载测试计划失败:",c)}}async function A(){var o;try{const e=await M.getList({per_page:100,...C});I.value=((o=e.data)==null?void 0:o.items)||[]}catch(e){console.error("加载可用用例失败:",e)}}async function q(){try{const o=await M.testSuite.getTree(),e=c=>{let i=[];for(const u of c)i.push(u),u.children&&(i=i.concat(e(u.children)));return i};R.value=e(o.data||[])}catch(o){console.error("加载文件夹失败:",o)}}function J(o){_.value=o}function K(o){return!S.value.some(e=>e.test_case_id===o.id)}function Q(o){f.value=o}function W(){g.value=!0,f.value=[],A(),q()}async function X(){try{const o=f.value.map(e=>e.id);await V.addCases(v.value,{case_ids:o}),r.success(`成功添加 ${o.length} 条用例`),g.value=!1,w()}catch{r.error("添加用例失败")}}function Y(o){L.confirm("确定要从计划中移除这条用例吗？","提示",{type:"warning"}).then(async()=>{try{await V.removeCases(v.value,{case_ids:[o.test_case_id]}),r.success("移除成功"),w()}catch{r.error("移除失败")}})}function Z(){L.confirm(`确定要移除选中的 ${_.value.length} 条用例吗？`,"提示",{type:"warning"}).then(async()=>{try{const o=_.value.map(e=>e.test_case_id);await V.removeCases(v.value,{case_ids:o}),r.success("移除成功"),w()}catch{r.error("移除失败")}})}function ee(o){h.value=o,n.status="passed",n.actual_result="",n.notes="",n.defect_ids=null,b.value=!0}function te(){r.info("批量执行功能开发中...")}function ae(){r.info("跳转到缺陷创建页面")}async function le(){try{await $e.create({test_plan_id:v.value,test_case_id:h.value.test_case_id,test_plan_case_id:h.value.id,status:n.status,actual_result:n.actual_result,notes:n.notes,executed_by:"current_user"}),r.success("提交成功"),b.value=!1,w()}catch{r.error("提交失败")}}function oe(){r.info("批量执行功能开发中...")}return ce(()=>{w()}),(o,e)=>{const c=me,i=we,u=be,k=Ce,F=ge,se=_e,B=ke,ne=Ve,ie=xe,N=fe,x=Ae,E=Te,ue=Be,de=Se;return y(),T("div",Ie,[t(c,{onBack:j,title:"返回"},{content:a(()=>[m("span",Re,d(D.value),1)]),_:1}),t(se,{style:{"margin-top":"20px"}},{header:a(()=>[m("div",Ue,[e[12]||(e[12]=m("span",null,"用例列表",-1)),m("div",Fe,[t(i,{type:"primary",onClick:W},{default:a(()=>[...e[10]||(e[10]=[s("添加用例",-1)])]),_:1}),t(i,{type:"success",onClick:oe},{default:a(()=>[...e[11]||(e[11]=[s("批量执行",-1)])]),_:1})])])]),default:a(()=>[t(F,{data:S.value,style:{width:"100%"},onSelectionChange:J},{default:a(()=>[t(u,{type:"selection",width:"55"}),t(u,{label:"编号",width:"120"},{default:a(({row:l})=>[s(d(l.case_no||`CASE-${l.test_case_id}`),1)]),_:1}),t(u,{prop:"name",label:"用例名称","show-overflow-tooltip":""}),t(u,{prop:"priority",label:"优先级",width:"100"},{default:a(({row:l})=>[t(k,{type:U(l.priority)},{default:a(()=>[s(d(l.priority),1)]),_:2},1032,["type"])]),_:1}),t(u,{prop:"last_status",label:"执行状态",width:"120"},{default:a(({row:l})=>[t(k,{type:G(l.last_status)},{default:a(()=>[s(d(H(l.last_status)),1)]),_:2},1032,["type"])]),_:1}),t(u,{prop:"assignee",label:"执行人",width:"120"}),t(u,{label:"操作",width:"150",fixed:"right"},{default:a(({row:l})=>[t(i,{type:"primary",link:"",size:"small",onClick:re=>ee(l)},{default:a(()=>[...e[13]||(e[13]=[s("执行",-1)])]),_:1},8,["onClick"]),t(i,{type:"danger",link:"",size:"small",onClick:re=>Y(l)},{default:a(()=>[...e[14]||(e[14]=[s("移除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]),_.value.length>0?(y(),T("div",Ne,[t(i,{type:"danger",onClick:Z},{default:a(()=>[s("批量移除 ("+d(_.value.length)+")",1)]),_:1}),t(i,{type:"success",onClick:te},{default:a(()=>[s("批量执行 ("+d(_.value.length)+")",1)]),_:1})])):ve("",!0)]),_:1}),t(N,{modelValue:g.value,"onUpdate:modelValue":e[3]||(e[3]=l=>g.value=l),title:"添加测试用例",width:"900px","destroy-on-close":""},{footer:a(()=>[t(i,{onClick:e[2]||(e[2]=l=>g.value=!1)},{default:a(()=>[...e[16]||(e[16]=[s("取消",-1)])]),_:1}),t(i,{type:"primary",onClick:X,disabled:f.value.length===0},{default:a(()=>[s(" 添加 ("+d(f.value.length)+") ",1)]),_:1},8,["disabled"])]),default:a(()=>[m("div",Pe,[t(B,{modelValue:C.keyword,"onUpdate:modelValue":e[0]||(e[0]=l=>C.keyword=l),placeholder:"搜索用例",clearable:"",style:{width:"200px"},onChange:A},null,8,["modelValue"]),t(ie,{modelValue:C.suite_id,"onUpdate:modelValue":e[1]||(e[1]=l=>C.suite_id=l),placeholder:"选择文件夹",clearable:"",onChange:A},{default:a(()=>[(y(!0),T(he,null,Ee(R.value,l=>(y(),$(ne,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),e[15]||(e[15]=m("div",{style:{flex:"1"}},null,-1)),m("span",null,"已选择: "+d(f.value.length),1)]),t(F,{data:I.value,onSelectionChange:Q,style:{width:"100%","max-height":"400px","overflow-y":"auto"}},{default:a(()=>[t(u,{type:"selection",width:"55",selectable:K}),t(u,{prop:"case_no",label:"编号",width:"120"}),t(u,{prop:"name",label:"用例名称","show-overflow-tooltip":""}),t(u,{prop:"priority",label:"优先级",width:"100"},{default:a(({row:l})=>[t(k,{type:U(l.priority)},{default:a(()=>[s(d(l.priority),1)]),_:2},1032,["type"])]),_:1}),t(u,{prop:"case_type",label:"类型",width:"100"},{default:a(({row:l})=>[t(k,{type:"info"},{default:a(()=>[s(d(l.case_type),1)]),_:2},1024)]),_:1})]),_:1},8,["data"])]),_:1},8,["modelValue"]),t(N,{modelValue:b.value,"onUpdate:modelValue":e[9]||(e[9]=l=>b.value=l),title:"执行测试用例",width:"700px","destroy-on-close":""},{footer:a(()=>[t(i,{onClick:e[8]||(e[8]=l=>b.value=!1)},{default:a(()=>[...e[23]||(e[23]=[s("取消",-1)])]),_:1}),t(i,{type:"primary",onClick:le},{default:a(()=>[...e[24]||(e[24]=[s("提交",-1)])]),_:1})]),default:a(()=>[t(de,{model:n,"label-width":"100px"},{default:a(()=>[t(x,{label:"用例名称"},{default:a(()=>{var l;return[m("span",null,d((l=h.value)==null?void 0:l.name),1)]}),_:1}),t(x,{label:"执行结果"},{default:a(()=>[t(ue,{modelValue:n.status,"onUpdate:modelValue":e[4]||(e[4]=l=>n.status=l)},{default:a(()=>[t(E,{label:"passed"},{default:a(()=>[...e[17]||(e[17]=[s("通过",-1)])]),_:1}),t(E,{label:"failed"},{default:a(()=>[...e[18]||(e[18]=[s("失败",-1)])]),_:1}),t(E,{label:"blocked"},{default:a(()=>[...e[19]||(e[19]=[s("阻塞",-1)])]),_:1}),t(E,{label:"skipped"},{default:a(()=>[...e[20]||(e[20]=[s("跳过",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(x,{label:"实际结果"},{default:a(()=>[t(B,{modelValue:n.actual_result,"onUpdate:modelValue":e[5]||(e[5]=l=>n.actual_result=l),type:"textarea",rows:4},null,8,["modelValue"])]),_:1}),t(x,{label:"备注"},{default:a(()=>[t(B,{modelValue:n.notes,"onUpdate:modelValue":e[6]||(e[6]=l=>n.notes=l),type:"textarea",rows:2},null,8,["modelValue"])]),_:1}),t(x,{label:"关联缺陷"},{default:a(()=>[n.defect_ids?(y(),$(k,{key:1,closable:"",onClose:e[7]||(e[7]=l=>n.defect_ids=null)},{default:a(()=>[...e[22]||(e[22]=[s(" 已关联缺陷 ",-1)])]),_:1})):(y(),$(i,{key:0,onClick:ae},{default:a(()=>[...e[21]||(e[21]=[s(" 新建缺陷 ",-1)])]),_:1}))]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},at=De(Le,[["__scopeId","data-v-8f6b56c5"]]);export{at as default};
